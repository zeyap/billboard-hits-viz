<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    </head>
    <style>

        h2{
            font-family: 'Montserrat', sans-serif;
            display: inline-block;
            transform: translateX(-50%);
            position: absolute;
            left:50%;
            color:white;
        }

        text{
          color:white;
          font-family: 'Montserrat', sans-serif
        }

        .axis line {
            stroke: white;
            /* opacity: 0.7; */
        }

        .axis path {
            stroke-width: 0;
        }

        svg{
            position: absolute;
            top: 100px;
        }

        body{
          background: black
        }

        .textcolor{
          color:white
        }


    </style>
    <body>
      <h2>

      </h2>


    <h2>
      Top Artists for Every 5 Years (1958-2019)
      Based on Number of Weeks on the Billboard Top 100
    </h2>

      <svg id="graph" height=1500 width="1000">
      </svg>

      <defs>
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script>

        let svg = d3.select("svg#graph");

        svg.attr("width",  window.innerWidth);
        window.onresize = ()=>{
            svg.attr("width",  window.innerWidth);
        }
        let height = svg.attr("height");
        let width = svg.attr("width");
        let margin = {top:20, right:20, bottom:20, left:20};

        let WGraph = width - margin.right - margin.left;
        let HGraph = height - margin.top - margin.bottom;

        let lower = svg.append('g')
        .attr('transform','translate('+margin.left*1.5+','+100+')');
        // .attr('transform','translate('+margin.left+','+(HGraph/2)+')');
//load the data


artistsPics=["connie-francis.png","beatles.jpg","james-brown.jpg","Gladys-knight.png","donna-summer.jpg","madonna.jpg","Michael-bolton.jpg","toni-braxton.jpg","Faith-Hill.jpg", "rascal-flatts.jpg","taylor-swift.jpg", "drake.jpg","drake.jpg"];
artistNames=["Connie Francis", "The Beatles", "James Brown", "Gladys Knight", "Donna Summer", "Madonna", "Michael Bolton", "Toni Braxton", "Faith Hill", "Rascal Flatts", "Taylor Swift", "Drake", "Drake"];

        d3.csv('../static/Hot Stuff.csv')
        .then(data=>{
            var dataByYear = [];
            var dataByPerformers = {};
            var dataBy5Years = [];
            const latestYear = 2019;
            let minYear = latestYear;

            //find min year & organize data by performer
            data.forEach(elem=>{
                let year = parseInt(elem.WeekID.split('/')[2]);
                minYear = Math.min(minYear, year);
                dataByYear[year] = dataByYear[year]||[];
                dataByYear[year].push(elem);

                dataByPerformers[elem.Performer] = dataByPerformers[elem.Performer]||[];
                dataByPerformers[elem.Performer][year] = dataByPerformers[elem.Performer][year]||[];
                dataByPerformers[elem.Performer][year].push(elem);
            });

            //data by 5 year
            let minPeriodId=Infinity, maxPeriodId=-1;
            for (let year in dataByYear){
                if(dataByYear[year] === undefined)continue;
                let period = Math.floor((parseInt(year)-minYear)/5);
                minPeriodId = Math.min(period,minPeriodId);
                maxPeriodId = Math.max(period,maxPeriodId);
                dataBy5Years[period] = (dataBy5Years[period]||[]).concat(dataByYear[year]);
            }

            // console.log(dataByPerformers)
            // console.log(dataBy5Years)

            //create scales
            const YScale = d3.scaleLinear()
              .domain ([500, 0])
              .range([HGraph/2,0]);

            // const XScale2 = d3.scaleLinear()
            //   .domain ()
            //   .range ()

            const XScale = d3.scaleLinear()
              .domain ([minPeriodId, maxPeriodId+1])
              .range ([0,WGraph]);


        //draw axes for graph 1
        var left_x_axis = d3.axisTop(XScale)
        .ticks(15)
        .tickFormat(id=>{
          let startyear = minYear+5*id;
          return startyear>latestYear?latestYear:startyear
        }).tickSize(0,0);

        var left_y_axis = d3.axisLeft(YScale)
        .ticks(maxPeriodId-minPeriodId+1)
        .tickFormat(week=>{
          if(week==0)return '# Weeks';
          else return week
        })
        .tickSize(-15,0)

        lower.append("g")
        .attr("transform","translate("+ (margin.right) +","+ margin.top +")")
        .attr('class','axis')
        .call(left_y_axis);

        lower.append("g")
        .attr('class','axis')
        .attr("transform","translate("+ (margin.left) +","+ margin.top +")")
        .call(left_x_axis);

        let favArtistsByWeek=[];
        //data organization for left graph
        dataBy5Years.forEach ( (arr,i) => {
          let artist;

          let artists = {};
          arr.forEach((d)=>{
            artists[d.Performer] = artists[d.Performer]||{weeksNum:0, songs:{}};
            artists[d.Performer].weeksNum++;
            artists[d.Performer].songs[d.Song] = artists[d.Performer].songs[d.Song]||0;
            artists[d.Performer].songs[d.Song]++;

          })

          let maxWeekNum = 0;
          let favArtist;
          for(let name in artists)
          {
            if(artists[name].weeksNum>maxWeekNum){
              maxWeekNum = artists[name].weeksNum;
              favArtist = artists[name];
              favArtist.name = name;
            }
          }
          favArtistsByWeek.push(favArtist);

        })
        // console.log(favArtistsByWeek);

        // const colors = ['#5fad4c','#ead38c','#b302e0','#0aa5ff', '#ffff08','#ff08d9','#c45a21','#336684', '#32ff00', '#ff7f00 ', '#ff0000', '#ffa8ca', '#ffa8ca'];
        const colors = ['#24A28E','#2AA4AA','#3290B1','#397DB8', '#416ABF','#4957C6','#5D52CC','#7F5BD1', '#9F66D7', '#BD72DC', '#D97DE1', '#E589D7', '#E994C9'];

        // const colors=['#C85AB4','#0D24DE','#24D3ED','#E5B0D9'];

        favArtistsByWeek.forEach((d,WeekID) => {
          let cx = margin.left+XScale(WeekID)+ (WGraph/24);
        //   for(let i=0;i<d.weeksNum;i++){
        //     if(i%5===0){
        //       let dot = lower.append("circle")
        //       .attr("cx", cx)
        //       .attr("cy", margin.top+YScale(i))
        //       .attr("r", 2)
        //       .style("fill", "red")
        //       .attr('opacity',0.00);

        //     }

        //   }
        
        let img = svg.append("image")
          .attr("xlink:href","/static/photos/"+ artistsPics[WeekID])
          .attr('x',0)
          .attr('y',0)
          .attr('height',50)
          .attr('width',50)
          .attr('transform','translate('+cx+','+10+')')
          svg.append("text")
          .text(artistNames[WeekID])
          .attr('transform','translate('+(cx+margin.left)+','+70+')')
          .attr ('alignment-baseline', 'central')
          .attr('style', 'text-anchor:middle')
          .attr ("font-size", 14)
          .attr ("fill", "white")
          .attr ("font-family", "'Montserrat', sans-serif");

          let totalWeekNum=0;

          //tops
          let sortedSongs=[];
          for(let songName in d.songs){
            sortedSongs.push({name:songName,count:d.songs[songName]});
          }
          sortedSongs.sort((a,b)=>b.count-a.count);
          let isTop3={};
          isTop3[sortedSongs[0].name]=1
          // isTop3[sortedSongs[1].name]=2
          // isTop3[sortedSongs[2].name]=3

          const opacityScale = d3.scaleLog()
              .domain ([1, 50])
              .range([0.2,1]);

          for(let songName in d.songs ){
            let songWeekNum = d.songs[songName]
            //const artistScale = d3.scaleOrdinal(d3.schemeCategory20);
            // if(songWeekNum<10)continue;
            // console.log(songWeekNum)
            let cy=margin.top+YScale(totalWeekNum+songWeekNum/2)
            //let artistcolor = artistScale(name);
            //console.log(artistScale)
            let dot2 = lower.append("circle")
            .attr ("cx", cx)
            .attr("cy", cy)
            .attr("r", YScale(songWeekNum/2))
            .attr('opacity',opacityScale(songWeekNum))
            .style("fill",colors[WeekID%colors.length])
            if(songWeekNum >= 26||isTop3[songName]) {
              let wordlength = songName.length;
              const lineLength = 10;
              const lineNum = Math.ceil(wordlength/lineLength);
            let text = lower.append('text')
            .text(songName)
            .attr ('x', cx)
            .attr ('y', cy)
            .attr ('alignment-baseline', 'central')
            .attr('style', 'text-anchor:middle')
            .attr ("font-size", 12)
            .attr ("fill", "white")
            .attr ("font-family", "'Montserrat', sans-serif");
            
          }
            totalWeekNum+=songWeekNum

          }

        })


        })

        </script>
    </body>
</html>
