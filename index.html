<!DOCTYPE html>
<html>
    <head>
        <script src="https://d3js.org/d3.v5.min.js"></script>
    </head>
    <style>

    </style>
    <body>

      <svg id="graph" height=2000 width="1000"> </svg>

    <script>

        let svg = d3.select("svg#graph");

        svg.attr("width",  window.innerWidth);
        window.onresize = ()=>{
            svg.attr("width",  window.innerWidth);
        }
        let height = svg.attr("height");
        let width = svg.attr("width");
        let margin = {top:20, right:20, bottom:20, left:20};

        let WGraph = width - margin.right - margin.left;
        let HGraph = height - margin.top - margin.bottom;

        let lower = svg.append('g')
        .attr('transform','translate('+margin.left+','+(HGraph/2)+')');

//load the data

        d3.csv('../static/Hot Stuff.csv')
        .then(data=>{
            var dataByYear = [];
            var dataByPerformers = {};
            var dataBy5Years = [];
            const latestYear = 2019;
            let minYear = latestYear;

            //find min year & organize data by performer
            data.forEach(elem=>{
                let year = parseInt(elem.WeekID.split('/')[2]);
                minYear = Math.min(minYear, year);
                dataByYear[year] = dataByYear[year]||[];
                dataByYear[year].push(elem);

                dataByPerformers[elem.Performer] = dataByPerformers[elem.Performer]||[];
                dataByPerformers[elem.Performer][year] = dataByPerformers[elem.Performer][year]||[];
                dataByPerformers[elem.Performer][year].push(elem);
            });

            //data by 5 year
            let minPeriodId=Infinity, maxPeriodId=-1;
            for (let year in dataByYear){
                if(dataByYear[year] === undefined)continue;
                let period = Math.floor((parseInt(year)-minYear)/5);
                minPeriodId = Math.min(period,minPeriodId);
                maxPeriodId = Math.max(period,maxPeriodId);
                dataBy5Years[period] = (dataBy5Years[period]||[]).concat(dataByYear[year]);
            }

            console.log(dataByPerformers)
            console.log(dataBy5Years)

            //create scales
            const YScale = d3.scaleLinear()
              .domain ([500, 0])
              .range([HGraph/2,0]);

            // const XScale2 = d3.scaleLinear()
            //   .domain ()
            //   .range ()

            const XScale = d3.scaleLinear()
              .domain ([minPeriodId, maxPeriodId+1])
              .range ([0,WGraph]);


        //draw axes for graph 1
        var left_x_axis = d3.axisTop(XScale)
        .ticks(15)
        .tickFormat(id=>{
          let startyear = minYear+5*id;
          return startyear
        });

        var left_y_axis = d3.axisLeft(YScale)
        .ticks(maxPeriodId-minPeriodId+1)

        lower.append("g")
        .attr("transform","translate("+ (margin.right) +","+ margin.top +")")
        .call(left_y_axis);

        lower.append("g")
        .attr("transform","translate("+ (margin.left) +","+ margin.top +")")
        .call(left_x_axis);

        let favArtistsByWeek=[];
        //data organization for left graph
        dataBy5Years.forEach ( (arr,i) => {
          let artist;

          let artists = {};
          arr.forEach((d)=>{
            artists[d.Performer] = artists[d.Performer]||{weeksNum:0, songs:{}};
            artists[d.Performer].weeksNum++;
            artists[d.Performer].songs[d.Song] = artists[d.Performer].songs[d.Song]||0;
            artists[d.Performer].songs[d.Song]++;

          })

          let maxWeekNum = 0;
          let favArtist;
          for(let name in artists)
          {
            if(artists[name].weeksNum>maxWeekNum){
              maxWeekNum = artists[name].weeksNum;
              favArtist = artists[name];
              favArtist.name = name;
            }
          }
          favArtistsByWeek.push(favArtist);

        })
        console.log(favArtistsByWeek);

        favArtistsByWeek.forEach((d,WeekID) => {
          let cx = margin.left+XScale(WeekID)+ (WGraph/24);
          for(let i=0;i<d.weeksNum;i++){
            if(i%5===0){
              let dot = lower.append("circle")
              .attr("cx", cx)
              .attr("cy", margin.top+YScale(i))
              .attr("r", 2)
              .style("fill", "red")
              .attr('opacity',0.00);

            }

          }

          let totalWeekNum=0;

          //tops
          let sortedSongs=[];
          for(let songName in d.songs){
            sortedSongs.push({name:songName,count:d.songs[songName]});
          }
          sortedSongs.sort((a,b)=>b.count-a.count);
          let isTop3={};
          isTop3[sortedSongs[0].name]=1
          //isTop3[sortedSongs[1].name]=2
          //isTop3[sortedSongs[2].name]=3

          for(let songName in d.songs ){
            let songWeekNum = d.songs[songName]
            //const artistScale = d3.scaleOrdinal(d3.schemeCategory20);
            // if(songWeekNum<10)continue;
            // console.log(songWeekNum)
            let cy=margin.top+YScale(totalWeekNum+songWeekNum/2)
            //let artistcolor = artistScale(name);
            //console.log(artistScale)
            let dot2 = lower.append("circle")
            .attr ("cx", cx)
            .attr("cy", cy)
            .attr("r", YScale(songWeekNum/2))
            .attr('opacity',0.2)
            .style("fill","red")
            if(songWeekNum >= 26||isTop3[songName]) {
            text = lower.append('text')
            .attr ('x', cx)
            .attr ('y', cy)
            .text (songName)
            .attr ('alignment-baseline', 'central')
            .attr('style', 'text-anchor:middle')
            .attr ("font-size", "14px")
            .attr ("fill", "black")
            .attr ("font-family", "helvetica");
          }
            totalWeekNum+=songWeekNum


          }



        })


        })







        </script>
    </body>
</html>
